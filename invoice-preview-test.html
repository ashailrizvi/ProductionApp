<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Preview Final Fix Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-4">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">🎯 Invoice Preview Test</h1>
        
        <div class="bg-yellow-800 p-4 rounded mb-6">
            <h3 class="font-bold text-yellow-200 mb-2">📋 Test Purpose</h3>
            <p class="text-yellow-100 text-sm">
                This test file is preserved to debug the remaining invoice modal dependency issue. 
                While Excel export template integration works, the invoice preview modal still requires 
                visiting the quotations page first despite all applied fixes.
            </p>
        </div>
        
        <div class="bg-green-800 p-4 rounded mb-6">
            <h3 class="font-bold text-green-200 mb-2">✅ Fixes Applied</h3>
            <ul class="list-disc list-inside space-y-1 text-green-100 text-sm">
                <li><strong>Function Access:</strong> formatCurrency() and formatDate() made globally accessible</li>
                <li><strong>Template Loading:</strong> Excel export now includes company template data</li>
                <li><strong>Z-Index Fix:</strong> Modals now use z-[60] instead of z-50 to avoid loading overlay conflicts</li>
                <li><strong>Event Binding:</strong> Improved button event listeners and error handling</li>
            </ul>
        </div>
        
        <div class="bg-blue-800 p-4 rounded mb-6">
            <h3 class="font-bold text-blue-200 mb-2">🧪 Test Instructions</h3>
            <ol class="list-decimal list-inside space-y-1 text-blue-100 text-sm">
                <li>Navigate to <strong>Invoices</strong> page in iframe below</li>
                <li>Click any <strong>Preview</strong> button (👁️ icon) <strong>WITHOUT</strong> visiting quotations first</li>
                <li>Invoice preview modal should open immediately with full company information</li>
                <li>If successful, the dependency issue is finally resolved!</li>
            </ol>
        </div>

        <div class="bg-gray-800 p-4 rounded mb-6">
            <h3 class="font-semibold mb-4">Quick Test Controls</h3>
            <div class="space-y-2">
                <button id="go-to-invoices" class="bg-blue-500 px-4 py-2 rounded mr-2">
                    📋 Go to Invoices Page
                </button>
                <button id="test-first-preview" class="bg-green-500 px-4 py-2 rounded mr-2">
                    👁️ Test First Preview Button
                </button>
                <button id="check-status" class="bg-purple-500 px-4 py-2 rounded mr-2">
                    📊 Check Fix Status
                </button>
            </div>
        </div>
        
        <div id="results" class="bg-gray-800 p-4 rounded mb-6 text-sm max-h-64 overflow-y-auto"></div>

        <iframe id="app" src="index.html" width="100%" height="600" class="border border-gray-600 rounded"></iframe>
    </div>

    <script>
        function log(message, type = 'info') {
            const div = document.createElement('div');
            const colors = {
                info: 'text-blue-300',
                success: 'text-green-300',
                error: 'text-red-300',
                warning: 'text-yellow-300'
            };
            div.className = colors[type] || colors.info;
            div.innerHTML = `<span class="text-gray-400">[${new Date().toLocaleTimeString()}]</span> ${message}`;
            document.getElementById('results').appendChild(div);
            document.getElementById('results').scrollTop = document.getElementById('results').scrollHeight;
        }
        
        function getApp() {
            return document.getElementById('app').contentWindow;
        }
        
        async function goToInvoices() {
            try {
                log('📋 Navigating to invoices page...', 'info');
                const app = getApp();
                
                app.showPage('invoices');
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                log('✅ Navigated to invoices page', 'success');
                
                // Count preview buttons
                const previewButtons = app.document.querySelectorAll('.preview-btn, button[data-invoice-id]');
                log(`🔍 Found ${previewButtons.length} preview buttons`, 'info');
                
            } catch (error) {
                log(`❌ Error navigating: ${error.message}`, 'error');
            }
        }
        
        async function testFirstPreview() {
            try {
                log('👁️ Testing first preview button...', 'warning');
                const app = getApp();
                
                // Make sure we're on invoices page
                app.showPage('invoices');
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const previewButtons = app.document.querySelectorAll('.preview-btn, button[data-invoice-id]');
                
                if (previewButtons.length === 0) {
                    log('❌ No preview buttons found', 'error');
                    return;
                }
                
                const firstButton = previewButtons[0];
                const invoiceId = firstButton.getAttribute('data-invoice-id');
                
                log(`🎯 Testing preview for invoice: ${invoiceId}`, 'info');
                
                // Click the button
                log('👆 Clicking preview button...', 'info');
                firstButton.click();
                
                // Wait for modal
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Check modal state
                const modal = app.document.getElementById('invoice-preview-modal');
                const loadingOverlay = app.document.getElementById('loading-overlay');
                
                if (!modal) {
                    log('❌ Modal element not found', 'error');
                    return;
                }
                
                const modalVisible = !modal.classList.contains('hidden');
                const loadingVisible = loadingOverlay && !loadingOverlay.classList.contains('hidden');
                
                log('📋 Test Results:', 'warning');
                log(`   Modal Visible: ${modalVisible ? 'YES ✅' : 'NO ❌'}`, modalVisible ? 'success' : 'error');
                log(`   Loading Overlay: ${loadingVisible ? 'STILL VISIBLE ⚠️' : 'Hidden ✅'}`, loadingVisible ? 'warning' : 'success');
                
                if (modalVisible) {
                    const modalStyle = app.getComputedStyle(modal);
                    log(`   Modal Z-Index: ${modalStyle.zIndex}`, 'info');
                    log(`   Modal Display: ${modalStyle.display}`, 'info');
                    
                    // Check for content
                    const content = modal.querySelector('#invoice-preview-content');
                    if (content && content.innerHTML.length > 100) {
                        log('   Content: ✅ Has content', 'success');
                        
                        // Check for company information
                        const hasCompanyInfo = content.innerHTML.includes('company') || content.innerHTML.includes('Company');
                        log(`   Company Info: ${hasCompanyInfo ? '✅' : '❌'}`, hasCompanyInfo ? 'success' : 'warning');
                    } else {
                        log('   Content: ❌ No content or very short', 'error');
                    }
                    
                    log('🎉 SUCCESS: Invoice preview is working!', 'success');
                    
                    // Close modal after 5 seconds
                    setTimeout(() => {
                        if (typeof app.closeInvoicePreview === 'function') {
                            app.closeInvoicePreview();
                            log('🚪 Modal closed automatically', 'info');
                        }
                    }, 5000);
                    
                } else {
                    log('💔 FAILED: Modal is not visible', 'error');
                    
                    if (loadingVisible) {
                        log('💡 Loading overlay still visible - this might be blocking the modal', 'warning');
                    }
                }
                
            } catch (error) {
                log(`❌ Error testing preview: ${error.message}`, 'error');
            }
        }
        
        function checkFixStatus() {
            try {
                log('📊 Checking fix status...', 'warning');
                const app = getApp();
                
                // Check functions
                const functions = {
                    formatCurrency: typeof app.formatCurrency,
                    formatDate: typeof app.formatDate,
                    previewInvoice: typeof app.previewInvoice,
                    showInvoicePreview: typeof app.showInvoicePreview
                };
                
                log('🔧 Function Status:', 'info');
                Object.entries(functions).forEach(([name, type]) => {
                    const status = type === 'function' ? '✅' : '❌';
                    log(`   ${name}: ${status} ${type}`, type === 'function' ? 'success' : 'error');
                });
                
                // Check elements
                const modal = app.document.getElementById('invoice-preview-modal');
                const loadingOverlay = app.document.getElementById('loading-overlay');
                
                log('🏗️ Elements Status:', 'info');
                log(`   Invoice Modal: ${modal ? '✅ Found' : '❌ Missing'}`, modal ? 'success' : 'error');
                log(`   Loading Overlay: ${loadingOverlay ? '✅ Found' : '❌ Missing'}`, loadingOverlay ? 'success' : 'error');
                
                if (modal && loadingOverlay) {
                    const modalZIndex = app.getComputedStyle(modal).zIndex;
                    const loadingZIndex = app.getComputedStyle(loadingOverlay).zIndex;
                    
                    log('📏 Z-Index Status:', 'info');
                    log(`   Modal: ${modalZIndex}`, 'info');
                    log(`   Loading: ${loadingZIndex}`, 'info');
                    
                    const zIndexOk = parseInt(modalZIndex) > parseInt(loadingZIndex);
                    log(`   Z-Index Fix: ${zIndexOk ? '✅ Modal higher' : '❌ Conflict'}`, zIndexOk ? 'success' : 'error');
                }
                
                // Check data
                const hasServices = app.window.services?.length || 0;
                const hasBundles = app.window.bundles?.length || 0;
                const hasCustomers = app.window.customers?.length || 0;
                
                log('📊 Data Status:', 'info');
                log(`   Services: ${hasServices} items`, hasServices > 0 ? 'success' : 'warning');
                log(`   Bundles: ${hasBundles} items`, hasBundles > 0 ? 'success' : 'warning');
                log(`   Customers: ${hasCustomers} items`, hasCustomers > 0 ? 'success' : 'warning');
                
                const allGood = Object.values(functions).every(type => type === 'function') && 
                               modal && loadingOverlay;
                
                log(`🎯 OVERALL STATUS: ${allGood ? 'READY FOR TESTING ✅' : 'ISSUES DETECTED ❌'}`, allGood ? 'success' : 'error');
                
            } catch (error) {
                log(`❌ Error checking status: ${error.message}`, 'error');
            }
        }
        
        // Event listeners
        document.getElementById('go-to-invoices').addEventListener('click', goToInvoices);
        document.getElementById('test-first-preview').addEventListener('click', testFirstPreview);
        document.getElementById('check-status').addEventListener('click', checkFixStatus);
        
        // Auto-run when app loads
        document.getElementById('app').addEventListener('load', function() {
            setTimeout(() => {
                log('🚀 App loaded, running status check...', 'success');
                checkFixStatus();
            }, 3000);
        });
    </script>
</body>
</html>